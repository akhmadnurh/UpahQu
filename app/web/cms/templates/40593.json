{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  let { date, limit, token } = req.body;\n  // let date = \"2022-01-24\";\n\n  let date_temp = date;\n  date = date.split(\"-\");\n  const year = date[0];\n  const month = date[1].slice(0, 1) == \"0\" ? date[1].slice(1, 2) : date[1];\n  const day = date[2];\n  const create_attendance = await db.presensi.create({\n    data: {\n      hari: day,\n      bulan: month,\n      tahun: year,\n      token: token,\n      limit: limit,\n    },\n  });\n  // Membuat presensi karyawan dengan default tidak hadir\n  if (create_attendance) {\n    // Mengambil semua karyawan\n    const karyawan = await db.pengguna.findMany({\n      where: {\n        id_role: 2,\n      },\n    });\n\n    // Mendapatkan id_presensi\n    const id_presensi = await db.presensi.findFirst({\n      where: {\n        hari: day,\n        bulan: month,\n        tahun: year,\n        token: token,\n        limit: limit,\n      },\n    });\n\n    // Semua perizinan yang berlaku/valid hari ini\n    const perizinan = await db.$queryRaw(\n      \"select * from perizinan where id_pengajuan=2\"\n    );\n    let perizinan_valid = [];\n    let date_now = new Date(date_temp);\n    for (let i = 0; i < perizinan.length; i++) {\n      let perizinan_start = new Date(perizinan[i].tgl_mulai);\n      let perizinan_end = new Date(perizinan[i].tgl_akhir);\n      if (\n        date_now.getTime() >= perizinan_start.getTime() &&\n        date_now.getTime() <= perizinan_end.getTime()\n      ) {\n        perizinan_valid.push(perizinan[i]);\n      }\n    }\n\n    // Memasukkan perizinan yang valid ke karyawan\n    for (let i = 0; i < karyawan.length; i++) {\n      for (let j = 0; j < perizinan_valid.length; j++) {\n        let id_status;\n        if (karyawan[i].id_pengguna == perizinan_valid[j].id_pengguna) {\n          if (perizinan_valid[j].jenis_perizinan == \"sakit\") {\n            id_status = 3;\n          } else if (perizinan_valid[j].jenis_perizinan == \"izin\") {\n            id_status = 4;\n          } else if (perizinan_valid[j].jenis_perizinan == \"cuti\") {\n            id_status = 5;\n          }\n        } else {\n          id_status = 2;\n        }\n        // Masukkan status\n        karyawan[i].id_status = id_status;\n      }\n    }\n\n    for (let i = 0; i < karyawan.length; i++) {\n      await db.karyawan_presensi.create({\n        data: {\n          id_presensi: id_presensi.id_presensi,\n          id_karyawan: karyawan[i].id_pengguna,\n          id_status: karyawan[i].id_status,\n        },\n      });\n    }\n  }\n  reply.send({\n    status: create_attendance ? \"success\" : \"error\",\n  })\n}","figma":{}},"title":"create-presensi","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"07087","slug":"/api/c-presensi","site":"*","id":"40593"}