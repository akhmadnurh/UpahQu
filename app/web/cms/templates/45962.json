{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  const { token, id_karyawan } = req.body;\n  // const token = \"aaaw22\";\n  let get_presensi = await db.$queryRaw(\n    \"select * from presensi where token='\" +\n      token +\n      \"'  order by id_presensi desc limit 1\"\n  );\n  get_presensi = get_presensi[0];\n\n  const date_now = new Date();\n  const date_presensi = new Date(\n    get_presensi.tahun,\n    get_presensi.bulan - 1,\n    get_presensi.hari,\n    parseInt(get_presensi.limit.slice(0, 2)),\n    parseInt(get_presensi.limit.slice(3, 5))\n  );\n\n  // Mengecek apakah presensi tepat waktu\n  const check_time =\n    date_now.getTime() <= date_presensi.getTime() ? true : false;\n\n  if (check_time) {\n    // Cek apakah presensi sudah ada\n    const check_attendance = await db.karyawan_presensi.count({\n      where: {\n        id_presensi: get_presensi.id_presensi,\n      },\n    });\n    if (check_attendance > 0) {\n      const update = await db.$queryRaw(\n        \"update karyawan_presensi set id_status=1 where id_karyawan=\" +\n          id_karyawan +\n          \" and id_presensi=\" +\n          get_presensi.id_presensi\n      );\n      // const update = await db.karyawan_presensi.update({\n      //   data: {\n      //     id_status: 1,\n      //   },\n      //   where: {\n      //     id_karyawan: id_karyawan,\n      //     id_presensi: get_presensi.id_presensi,\n      //   },\n      // });\n      if (update) {\n        reply.send({\n          status: \"success-update\",\n        });\n      }\n    } else {\n      const add = await db.karyawan_presensi.create({\n        data: {\n          id_presensi: get_presensi.id_presensi,\n          id_karyawan: id_karyawan,\n          id_status: 1,\n        },\n      });\n      if (add) {\n        reply.send({\n          status: \"success-add\",\n        });\n      }\n    }\n  } else {\n    reply.send({\n      status: \"error-late\",\n    });\n  }\n}","figma":{}},"title":"user-presensi","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"53726","slug":"/api/user/presensi","site":"*","id":"45962"}